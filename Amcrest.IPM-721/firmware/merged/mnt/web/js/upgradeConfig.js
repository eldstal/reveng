!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab")}),define("upg_upgrade",function(require,b,c){var d=["None","DownloadFailed","Invalid","Failed","Succeeded","Cancelled","NotEnoughMemory"],e=require("jsCore/pageBase"),f=require("jsCore/rpc"),g=null,h=null,i=null,j=null,k=null,l=null,m=null,n=null,o=0,p=!1,q=!1;c.exports=e.extend({init:function(){g=this,h=g.$("#upg_upgrade"),i=g.$("#upg_path"),j=g.$("#upg_import"),k=g.$("#upg_probar"),l=g.$("#upg_process"),m=g.$("#upg_updating"),n=g.$("#upg_update"),h.on("change blur",g._onUpgradeChange),h.hover(function(){j.addClass("ui-button-hover")},function(){j.removeClass("ui-button-hover")}),$upgradeDownload=g.$("#upgrade_download"),$upgradeDownload.on("click",function(){"nacl"==plugin.type?plugin.OpenHelp("http://amcrest.com/firmware.html",1):window.open("http://amcrest.com/firmware.html")}),$ManualUpgrade=g.$("#ManualUpgrade"),$ManualUpgrade.on("click",function(){g.beginCloud()}),g.render()},render:function(){i.val(""),a("#upgrade_cloud").removeClass("fn-hide"),g_cloudInfo&&canUpgrade&&(a("#markframe").show(),a("#cloud_upgrade_probar").show(),a("#cloud_upgrade_speed").show(),f.Upgrader.start(function(){}),o=window.setInterval(g._getCloudInfo,2e3))},onSelectFile:function(){h.trigger("click")},_onUpgradeChange:function(){var b=a(this).val().split("\\");i.val(b[b.length-1])},onUpdate:function(){var a=h.val();""!==i.val()&&(a.test(".bin","i")?(g.disabled(n,!0),g.$("#upg_submit").trigger("click"),k.css("visibility","visible"),l.css("width","25px")):g.$(".u-tip").tip("warning",tl("Bad file format!")))},_getStatus:function(){f.Upgrader.getState().done(function(a){g._getStatusSuccess(a)}).fail(function(a){g._getStatusFails(a)})},_getStatusSuccess:function(a){switch(a.State){case"Invalid":g._upgradeFails("w_badFiletoReboot");break;case"Failed":case"NotEnoughMemory":case"Cancelled":g._upgradeFails("w_Upgradefailed");break;case"FileUnmatch":g._upgradeFails("w_FileUnmatch");break;default:g._upgrading(a.Progress)}},_getStatusFails:function(a){a.result===!1?(g.$(".u-tip").tip("warning",tl("Operateingfailure")),g.disabled(n,!1),k.css("visibility","hidden")):(l.css("width","251px"),m.text(tl("w_Rebooting...")),window.setTimeout(g._locationToIndex,2e4))},_upgradeFails:function(a){g.disabled(n,!1),k.css("visibility","hidden"),webApp.reboot(a,!0)},_upgrading:function(a){10>a&&(a=10),l.css("width",251*a/100+"px"),100==a?(m.text(tl("w_Rebooting...")),window.setTimeout(g._locationToIndex,2e4)):window.setTimeout(g._getStatus,1e3)},_getCloudInfo:function(){f.Upgrader.check().done(function(b){g_cloudInfo=b.info,g.$("#cloud_upgradeState").text(g_cloudInfo.State),g.$("#cloud_upgrade_process").css("width",255*g_cloudInfo.Progress/100+"px"),g.$("#cloud_upgrade_speed").text(g_cloudInfo.Progress+"%"),a.inArray(g_cloudInfo.State,d)>-1&&(clearInterval(o),g_cloudInfo=null,canUpgrade=!1,a("#cloud_upgrade_probar").addClass("fn-hide"),g.$("#cloud_upgrade_speed").text("Succeeded"==g_cloudInfo.State?"Upgrade Success":"Upgrade Error"))})},_locationToIndex:function(){a(window).unbind("unload"),a(window).unbind("beforeunload"),plugin.Reload()},beginCloud:function(){f.Upgrader.check().done(function(b){g_cloudInfo=b.info,g_cloudInfo&&"None"!=g_cloudInfo.State&&(p=!0,"regular"==g_cloudInfo.type.toLocaleLowerCase()?(a("#cloudDialog").show(),a("#cloud_curVer").text(g_cloudInfo.OldVersion),a("#cloud_upVer").text(g_cloudInfo.NewVersion),a("#cloud_updata").click(function(){a("#cloudDialog").hide(),f.Upgrader.start(function(){}),g.$("#cloud_upgrade_probar").show(),o=window.setInterval(g._getCloudInfo,2e3)}),a("#cloud_cancel").click(function(){g_cloudInfo=null,q=!0,a("#cloudDialog").hide()})):(a("#upgradeDialog").hide(),a("#go_updata").click(function(){g.disabled(n,!0),f.Upgrader.start(function(){}),g.$("#cloud_upgrade_probar").show(),a("#upgradeDialog").hide(),o=window.setInterval(g._getCloudInfo,2e3)})))})}}),window.downSucceed=function(){g._getStatus()}})}(jQuery);