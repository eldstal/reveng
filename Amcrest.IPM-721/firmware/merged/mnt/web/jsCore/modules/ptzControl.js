!function(a){define(function(require,b,c){function d(b,c){var d=this;d.options=a.extend({},j,c),d.e=a(b).empty().append(i).translation(),d.init()}function e(){var b=0;return a.when(g.get("LensControl"),g.get("LensControlMix"),g.get("smallPtz")).then(function(a,c,d){return b=a&&a.Support?2:d&&d.Support?4:c&&c.Support?3:webApp.CHANNEL_NUMBER>1?1:0})}var f=require("../plugin"),g=require("../ability"),h=require("../rpc"),i=require("./ptzControl.html");require("widget/js/dui.drag");var j={autoFocus:!1,isLaserDistMeasure:!1,channel:0};a.fn.ptzControl=function(){var b=arguments[0],c=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],e=this;return this.each(function(){var f=a(this),g=f.data("ptzControl");if(g||f.data("ptzControl",g=new d(f,b)),"string"===a.type(b)&&a.isFunction(g[b])){var h=g[b].apply(g,c);if(void 0!==h)return e=h,!1}}),e},d.prototype.init=function(){function b(b){var c=b?k.pop():k.shift();c&&(j=c,h.PTZ.start(c.dir,c.step,-1!==a.inArray(c.dir,d)?c.step:0,0))}var c=this,d=["LeftUp","RightUp","LeftDown","RightDown"],i=null,j=null,k=[];e().done(function(a){c.type=a}),c.$(".u-tab").tab(),c.drager=c.$(".vR-area").drag({position:"center",dragElements:".vR-control",distance:35,autoReset:!0,start:function(){i=setInterval(b,500)},drag:function(b,d){a.browser.ie7?(c.$(".vR-control").css("cursor","move"),c.drager.css("cursor","pointer")):(c.$(".vR-control").css("cursor","none"),c.drager.css("cursor","none"));var e=d.position.x-d.firstPosition.x,f=d.firstPosition.y-d.position.y,g=Math.round(4*Math.atan2(f,e)/Math.PI)+3,h=["LeftDown","Down","RightDown","Right","RightUp","Up","LeftUp","Left"],i=parseInt(Math.round(Math.sqrt(Math.pow(Math.abs(e),2)+Math.pow(Math.abs(f),2)))/5)+1;-1===g&&(g=7);var j=h[g],l=k[k.length-1];l&&l.dir===j&&l.step===i||k.push({dir:j,step:i})},stop:function(){if(c.$(".vR-control").css("cursor","pointer"),c.drager.css("cursor","auto"),null===j&&k.length&&b(!0),j){var e=j.dir,f=j.step;setTimeout(function(){h.PTZ.stop(e,f,-1!==a.inArray(e,d)?f:0,0)},450)}clearInterval(i),i=null,j=null,k.length=0}}),c.$(".vR-control").on("mousewheel",function(a,b){return h.PTZ.continueMoveDirectly(0,0,!1,[0,0,.1*b],c.options.channel),!1}),c.$("#ptz_locate").on("click",function(){f.activePTZLocate(c.$("#ptz_locate"))}),c.$("a[cmd]").on("mousedown",function(b){var d=c.$(b.currentTarget),e=c.$("#ptz_step").val()-0,f=0,g=d.attr("cmd"),i=!0,j=0,k=0,l=!1;if(-1!==a.inArray(g,["LeftUp","RightUp","LeftDown","RightDown"])&&(f=e),a.inArray(g,["ZoomWide","ZoomTele","FocusFar","FocusNear"])>-1&&(2==c.type||(3==c.type||4==c.type)&&1==c.options.channel)){switch(i=!1,l=!1,g){case"ZoomWide":k=-1,j=-.5;break;case"ZoomTele":k=-1,j=.5;break;case"FocusFar":k=-.5,j=-1;break;case"FocusNear":k=.5,j=-1;break;default:k=-1,j=-1}if(4==c.type)var m=h.DevVideoInput.adjustFocusContinuously(k,j,c.options.channel);else setTimeout(function(){if(i){var a=h.DevVideoInput.adjustFocus(k,j,c.options.channel);a.done(function(){var a=-1==k?-1:0,b=-1==j?-1:0;h.DevVideoInput.adjustFocus(a,b,c.options.channel)}),l=!0}else{var a=h.DevVideoInput.adjustFocusContinuously(k,j,c.options.channel);l=!0}},200)}else var m=h.PTZ.start(g,e,f,0);d.on("mouseup mouseout",function(){if(i=!0,d.off("mouseup mouseout"),-1===a.inArray(g,["ZoomWide","ZoomTele","FocusFar","FocusNear"])||2!=c.type&&(3!=c.type&&4!=c.type||1!=c.options.channel))m.done(function(){h.PTZ.stop(g,e,f,0)});else{var b=-1==k?-1:0,n=-1==j?-1:0;4==c.type?h.DevVideoInput.adjustFocusContinuously(b,n,c.options.channel):l&&h.DevVideoInput.adjustFocusContinuously(b,n,c.options.channel)}})}),g.get("PTZCaps").done(function(a){a&&(a.Zoom===!1&&c.$("#ptz_zoom_wrap").remove(),a.Focus===!1&&c.$("#ptz_focus_wrap").remove(),a.Iris===!1&&c.$("#ptz_iris_wrap").remove(),1===c.type&&c.options.channel?c.$("#ptz_zoom_wrap, #ptz_focus_wrap, #ptz_focus_wrap").hide():c.$("#ptz_zoom_wrap, #ptz_focus_wrap, #ptz_focus_wrap").show())})},d.prototype.$=function(a){return this.e.find(a)},d.prototype.changeChannel=function(a){var b=this;1===b.type&&a?b.$("#ptz_zoom_wrap, #ptz_focus_wrap, #ptz_iris_wrap").hide():b.$("#ptz_zoom_wrap, #ptz_focus_wrap, #ptz_iris_wrap").show()},c.exports=d})}(jQuery);